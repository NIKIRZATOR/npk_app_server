server {
    listen 80;
    server_name localhost;

    # --- Backend прокси ---
    location /auth/ {
        proxy_pass http://auth:6100;
        rewrite ^/auth/(.*) /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /data/ {
        proxy_pass http://data:6200;
        rewrite ^/data/(.*) /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Frontend (Flutter web) ---
    root /app;

    # 1) Никогда не кэшировать "точку входа" SPA
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files /index.html =404;
    }

    # 2) Никогда не кэшировать файл версии и сервис-воркер
    location = /version.json {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files /version.json =404;
    }

    location = /flutter_service_worker.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files /flutter_service_worker.js =404;
    }

    # 3) main.dart.js лучше не кешировать (имя без хэша, часто меняется)
    location = /main.dart.js {
        add_header Cache-Control "no-cache" always;
        try_files /main.dart.js =404;
    }

    # 4) Остальные статические ассеты — кэшировать агрессивно
    location ~* \.(?:png|jpg|jpeg|gif|webp|svg|ico|css|js|json|wasm|woff2?)$ {
        # если имена файлов с хэшем — можно immutable на год
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        try_files $uri =404;
    }

    # 5) SPA‑роутинг: всё остальное отдаём index.html
    location / {
        try_files $uri $uri/ /index.html;
    }
}